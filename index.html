<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Product Payment</title>
    <!-- Tailwind CSS 美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD&components=buttons,marks,hosted-fields"></script>
    <style>
        .card-input { transition: all 0.3s ease; }
        .card-input:focus { transform: scale(1.02); }
        .paypal-button { border-radius: 20px !important; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="gradient-bg min-h-screen p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-2xl p-6 space-y-6">
        <h1 class="text-3xl font-bold text-center text-purple-700">Digital Product Checkout</h1>

        <!-- 配置区域 -->
        <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">PayPal Client ID</label>
                <input type="text" id="clientId" 
                    class="card-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500"
                    placeholder="输入Client ID">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">货币类型</label>
                    <select id="currency" class="card-input mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="USD">美元 (USD)</option>
                        <option value="CAD">加元 (CAD)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">商品金额</label>
                    <input type="number" id="amount" step="0.01" 
                        class="card-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                        placeholder="输入金额">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">商品描述</label>
                <textarea id="description" rows="2"
                    class="card-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                    placeholder="输入商品详细描述"></textarea>
            </div>

            <div class="partner-section space-y-2">
                <div class="flex items-center space-x-2">
                    <input type="email" id="partnerEmail" 
                        class="card-input flex-1 rounded-md border-gray-300 shadow-sm"
                        placeholder="合作伙伴PayPal邮箱">
                    <input type="number" id="partnerPercent" step="1" min="1" max="99" 
                        class="card-input w-20 rounded-md border-gray-300 shadow-sm"
                        placeholder="%">
                    <button onclick="addPartner()" 
                        class="px-3 py-1 bg-purple-600 text-white rounded-md hover:bg-purple-700">添加分润</button>
                </div>
                <div id="partnerList" class="text-sm text-gray-600"></div>
            </div>
        </div>

        <!-- 支付按钮容器 -->
        <div id="paypal-button-container" class="text-center"></div>
        
        <!-- 生成链接区域 -->
        <div class="text-center">
            <button onclick="generatePaymentLink()" 
                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105">
                生成支付链接
            </button>
            <div id="paymentLink" class="mt-4 break-words text-blue-600"></div>
        </div>
    </div>

    <script>
        let partners = [];
        
        // 添加合作伙伴
        function addPartner() {
            const email = document.getElementById('partnerEmail').value;
            const percent = parseFloat(document.getElementById('partnerPercent').value);
            
            if(validateEmail(email) && percent > 0 && percent < 100) {
                partners.push({ email, value: (percent/100).toFixed(2) });
                updatePartnerList();
            }
        }

        // 更新合作伙伴列表显示
        function updatePartnerList() {
            const list = document.getElementById('partnerList');
            list.innerHTML = partners.map(p => 
                `<div>${p.email} - ${p.value*100}%</div>`
            ).join('');
        }

        // 生成支付链接
        function generatePaymentLink() {
            const clientId = document.getElementById('clientId').value;
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const description = document.getElementById('description').value;

            if(!clientId || !amount || !description) {
                alert('请填写完整信息');
                return;
            }

            const paymentData = {
                clientId,
                amount,
                currency,
                description,
                partners: JSON.stringify(partners)
            };

            const base64Data = btoa(JSON.stringify(paymentData));
            const paymentLink = `${window.location.href}?payment=${base64Data}`;
            
            document.getElementById('paymentLink').innerHTML = `
                <p>支付链接：</p>
                <a href="${paymentLink}" target="_blank" class="underline">${paymentLink}</a>
                <p class="mt-2 text-gray-600">复制该链接发送给客户</p>
            `;
        }

        // 初始化PayPal按钮
        function initPayPalButton(config) {
            paypal.Buttons({
                style: {
                    shape: 'pill',
                    color: 'gold',
                    layout: 'vertical'
                },
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            category: "DIGITAL_GOODS",
                            description: config.description,
                            amount: {
                                value: config.amount,
                                currency_code: config.currency,
                                breakdown: {
                                    item_total: { value: config.amount, currency_code: config.currency }
                                }
                            },
                            items: [{
                                name: config.description,
                                unit_amount: { value: config.amount, currency_code: config.currency },
                                quantity: "1",
                                category: "DIGITAL_GOODS"
                            }],
                            shipping: { 
                                address: { 
                                    address_line_1: "NO_SHIPPING",
                                    admin_area_2: "Virtual Product",
                                    country_code: "US" 
                                } 
                            },
                            payments: {
                                captures: [{
                                    disbursement_mode: "INSTANT",
                                    payees: config.partners
                                }]
                            }
                        }],
                        application_context: {
                            shipping_preference: "NO_SHIPPING"
                        }
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(orderData) {
                        console.log('Capture result', orderData);
                        alert('支付成功！');
                    });
                }
            }).render('#paypal-button-container');
        }

        // 页面加载时处理URL参数
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentParam = urlParams.get('payment');
            
            if(paymentParam) {
                const paymentData = JSON.parse(atob(paymentParam));
                Object.keys(paymentData).forEach(key => {
                    const el = document.getElementById(key);
                    if(el) el.value = paymentData[key];
                });
                partners = JSON.parse(paymentData.partners);
                updatePartnerList();
                
                // 重新初始化PayPal SDK
                const script = document.createElement('script');
                script.src = `https://www.paypal.com/sdk/js?client-id=${paymentData.clientId}&currency=${paymentData.currency}`;
                document.head.appendChild(script);
                
                script.onload = () => {
                    initPayPalButton({
                        amount: paymentData.amount,
                        currency: paymentData.currency,
                        description: paymentData.description,
                        partners: partners
                    });
                };
            }
        };

        // 邮箱验证
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
    </script>
</body>
</html>
